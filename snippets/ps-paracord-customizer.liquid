{%- comment -%}
  Pfotenstore â€“ Paracord Konfigurator (Dawn)
  FÃ¼gt Line Item Properties fÃ¼r maÃŸgeschneiderte Leine/Halsband hinzu.

  Verwendung:
  {% render 'ps-paracord-customizer', product: product %}
{%- endcomment -%}

{%- comment -%} PrÃ¼fe ob der Customizer fÃ¼r dieses Produkt angezeigt werden soll {%- endcomment -%}
{%- assign show_customizer = false -%}

{%- comment -%} Wenn display_method Ã¼bergeben wird, verwende diese Logik {%- endcomment -%}
{%- if display_method -%}
  {%- case display_method -%}
    {%- when 'manual' -%}
      {%- assign show_customizer = true -%}
    {%- when 'tag' -%}
      {%- if required_tags != blank -%}
        {%- assign tag_list = required_tags | split: ',' -%}
        {%- for tag in tag_list -%}
          {%- assign clean_tag = tag | strip -%}
          {%- if product.tags contains clean_tag -%}
            {%- assign show_customizer = true -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- when 'collection' -%}
      {%- if required_collections != blank -%}
        {%- assign collection_list = required_collections | split: ',' -%}
        {%- for collection_handle in collection_list -%}
          {%- assign clean_collection = collection_handle | strip -%}
          {%- for collection in product.collections -%}
            {%- if collection.handle == clean_collection -%}
              {%- assign show_customizer = true -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if show_customizer -%}{%- break -%}{%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- when 'auto' -%}
      {%- comment -%} Automatische Erkennung {%- endcomment -%}
      {%- if product.metafields.custom.enable_paracord_customizer == true -%}
        {%- assign show_customizer = true -%}
      {%- elsif product.tags contains 'paracord-customizer' -%}
        {%- assign show_customizer = true -%}
      {%- elsif product.type contains 'paracord' or product.type contains 'leash' or product.type contains 'collar' -%}
        {%- assign show_customizer = true -%}
      {%- else -%}
        {%- for collection in product.collections -%}
          {%- if collection.handle contains 'paracord'
            or collection.handle contains 'hundehalsbaender'
            or collection.handle contains 'leinen'
          -%}
            {%- assign show_customizer = true -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
  {%- endcase -%}
{%- else -%}
  {%- comment -%} Fallback: Automatische Erkennung {%- endcomment -%}
  {%- if product.metafields.custom.enable_paracord_customizer == true -%}
    {%- assign show_customizer = true -%}
  {%- elsif product.tags contains 'paracord-customizer' -%}
    {%- assign show_customizer = true -%}
  {%- elsif product.type contains 'paracord' or product.type contains 'leash' or product.type contains 'collar' -%}
    {%- assign show_customizer = true -%}
  {%- else -%}
    {%- for collection in product.collections -%}
      {%- if collection.handle contains 'paracord'
        or collection.handle contains 'hundehalsbaender'
        or collection.handle contains 'leinen'
      -%}
        {%- assign show_customizer = true -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- endif -%}

{%- unless show_customizer -%}
  {%- comment -%} Customizer wird nicht angezeigt {%- endcomment -%}
  {%- return -%}
{%- endunless -%}

<style>
  .ps-cust {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    margin: 16px 0;
    background: #fafafa;
  }
  .ps-cust h4 {
    margin: 0 0 8px;
    font-size: 16px;
  }
  .ps-cust .grid {
    display: grid;
    gap: 12px;
  }
  .ps-cust label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .ps-cust select,
  .ps-cust input[type='text'],
  .ps-cust textarea {
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 14px;
    background: #fff;
  }
  .ps-cust .row {
    display: grid;
    gap: 12px;
    grid-template-columns: 1fr 1fr;
  }
  .ps-cust small {
    color: #6b7280;
    font-size: 12px;
  }
  .ps-preview {
    margin-top: 10px;
    font-size: 13px;
    color: #374151;
  }
  @media (max-width: 720px) {
    .ps-cust .row {
      grid-template-columns: 1fr;
    }
  }
</style>

<div id="ps-customizer" class="ps-cust">
  <h4>
    {% if customizer_title != blank %}{{ customizer_title }}{% else %}ðŸŽ¨ Dein Jasmin-Set konfigurieren{% endif %}
  </h4>
  <div class="grid">
    <div class="row">
      <div>
        <label for="ps-length">LÃ¤nge (Leine)</label>
        <select id="ps-length" name="properties[LeinenlÃ¤nge]">
          <option value="1,5 m">1,5 m</option>
          <option value="2,0 m" selected>2,0 m</option>
          <option value="3,0 m">3,0 m</option>
        </select>
      </div>
      <div>
        <label for="ps-karabiner">Karabiner</label>
        <select id="ps-karabiner" name="properties[Karabiner]">
          <option value="Schwarz â€“ Stahl" selected>Schwarz â€“ Stahl</option>
          <option value="Silber â€“ Stahl">Silber â€“ Stahl</option>
          <option value="Gold â€“ Messing">Gold â€“ Messing</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="ps-color">Farbschema</label>
        <select id="ps-color" name="properties[Farbschema]">
          <option value="Jasmin (Bordeaux/WeiÃŸ/Schwarz/RosÃ©)" selected>Jasmin (Bordeaux/WeiÃŸ/Schwarz/RosÃ©)</option>
          <option value="Jasmin dunkel (Bordeaux/Schwarz/RosÃ©)">Jasmin dunkel (Bordeaux/Schwarz/RosÃ©)</option>
          <option value="Eigenes Schema">Eigenes Schema (im Feld â€žHinweiseâ€œ angeben)</option>
        </select>
      </div>
      <div>
        <label for="ps-halsband">Halsband-GrÃ¶ÃŸe</label>
        <select id="ps-halsband" name="properties[Halsband-GrÃ¶ÃŸe]">
          <option value="XS (25â€“30 cm)">XS (25â€“30 cm)</option>
          <option value="S (30â€“35 cm)">S (30â€“35 cm)</option>
          <option value="M (35â€“40 cm)" selected>M (35â€“40 cm)</option>
          <option value="L (40â€“45 cm)">L (40â€“45 cm)</option>
          <option value="XL (45â€“50 cm)">XL (45â€“50 cm)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="ps-name">Gravur â€“ Name (optional)</label>
        <input id="ps-name" type="text" name="properties[Gravur Name]" maxlength="20" placeholder="z. B. Bella">
        <small>Max. 20 Zeichen</small>
      </div>
      <div>
        <label for="ps-phone">Gravur â€“ Telefon (optional)</label>
        <input
          id="ps-phone"
          type="text"
          name="properties[Gravur Telefon]"
          maxlength="20"
          placeholder="z. B. +41 79 123 45 67"
        >
      </div>
    </div>

    <div>
      <label for="ps-notes">Hinweise (Farben, SonderwÃ¼nsche)</label>
      <textarea
        id="ps-notes"
        name="properties[Hinweise]"
        rows="3"
        placeholder="Z. B. Farbtausch, Ring in Gold, besondere WÃ¼nsche â€¦"
      ></textarea>
    </div>

    <div class="ps-preview" aria-live="polite">
      <strong>Deine Auswahl:</strong>
      <span id="ps-preview-text">2,0 m â€¢ Karabiner Schwarz â€“ Stahl â€¢ Farbschema Jasmin â€¢ Halsband M</span>
    </div>
  </div>
</div>

<script>
  (function () {
    // Sicherstellen, dass der Customizer IM Add-to-Cart-Formular sitzt (Dawn nutzt <product-form><form>â€¦)
    function moveCustomizerIntoForm() {
      try {
        var form = document.querySelector('product-form form') || document.querySelector('form[action*="/cart/add"]');
        var box = document.getElementById('ps-customizer');
        if (form && box && !form.contains(box)) {
          var atc = form.querySelector('[type="submit"]') || form.querySelector('button[type="submit"]');
          atc ? form.insertBefore(box, atc) : form.appendChild(box);
          console.log('PS Customizer: In Form integriert');
        }
      } catch (e) {
        console.error('PS Customizer Fehler:', e);
      }
    }
    function updatePreview() {
      var length = document.getElementById('ps-length')?.value || '';
      var karabiner = document.getElementById('ps-karabiner')?.value || '';
      var color = document.getElementById('ps-color')?.value || '';
      var halsband = document.getElementById('ps-halsband')?.value || '';

      var t = [
        length ? 'Leine: ' + length : '',
        karabiner ? 'Karabiner: ' + karabiner : '',
        color ? 'Farbschema: ' + color : '',
        halsband ? 'Halsband: ' + halsband : '',
      ]
        .filter(Boolean)
        .join(' â€¢ ');

      var el = document.getElementById('ps-preview-text');
      if (el) el.textContent = t || 'Bitte wÃ¤hle deine Optionen';
    }
    // Event-Listener fÃ¼r verschiedene Shopify-Events
    ['DOMContentLoaded', 'shopify:section:load', 'shopify:section:select'].forEach(function (evt) {
      document.addEventListener(evt, function () {
        setTimeout(function () {
          moveCustomizerIntoForm();
          updatePreview();
          attachEventListeners();
        }, 100);
      });
    });

    // Event-Listener fÃ¼r Customizer-Felder
    function attachEventListeners() {
      ['ps-length', 'ps-karabiner', 'ps-color', 'ps-halsband'].forEach(function (id) {
        var el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', updatePreview);
          el.addEventListener('input', updatePreview);
        }
      });
    }

    // Initiale AusfÃ¼hrung
    moveCustomizerIntoForm();
    updatePreview();
    attachEventListeners();
  })();
</script>
