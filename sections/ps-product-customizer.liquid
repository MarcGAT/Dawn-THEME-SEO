<div class="ps-product-customizer" data-ps-customizer>
  {%- comment -%}
    Füge eigene Eingaben (input/select/textarea) hier ein.
    Beschrifte sie mit data-ps-prop="Label" oder setze name="ps_<schlüssel>".
    Beispiel:
    <select data-ps-prop="Farbe">
      <option value="Schwarz">Schwarz</option>
      <option value="Rot">Rot</option>
    </select>
  {%- endcomment -%}
  <div class="ps-fields">
    <div class="field">
      <label for="ps-farbe">Farbe</label>
      <select id="ps-farbe" data-ps-prop="Farbschema">
        <option value="Schwarz">Schwarz</option>
        <option value="Rot">Rot</option>
        <option value="Grün">Grün</option>
        <option value="Blau">Blau</option>
      </select>
    </div>

    <div class="field">
      <label for="ps-laenge">Leinenlänge (cm)</label>
      <input
        id="ps-laenge"
        type="number"
        min="50"
        max="300"
        step="1"
        data-ps-prop="Leinenlänge"
        placeholder="z. B. 120"
      >
    </div>

    <div class="field">
      <label for="ps-karabiner">Karabiner</label>
      <select id="ps-karabiner" data-ps-prop="Karabiner">
        <option value="Standard">Standard</option>
        <option value="Messing">Messing</option>
        <option value="Edelstahl">Edelstahl</option>
        <option value="Schwarz Matt">Schwarz Matt</option>
      </select>
    </div>

    <div class="field">
      <label for="ps-gravur-name">Gravur Name</label>
      <input id="ps-gravur-name" type="text" maxlength="20" data-ps-prop="Gravur Name" placeholder="Name">
    </div>

    <div class="field">
      <label for="ps-gravur-telefon">Gravur Telefon</label>
      <input
        id="ps-gravur-telefon"
        type="text"
        maxlength="20"
        data-ps-prop="Gravur Telefon"
        placeholder="Telefonnummer"
      >
    </div>

    <div class="field">
      <label for="ps-hinweise">Hinweise</label>
      <textarea id="ps-hinweise" rows="2" data-ps-prop="Hinweise" placeholder="Besondere Wünsche ..."></textarea>
    </div>
  </div>
</div>

<script>
  (function () {
    function findProductForm(startEl) {
      // Suche das nächste Produkt-Formular innerhalb des Product-Sections
      var el = startEl;
      while (el) {
        var form = el.querySelector && el.querySelector('form[action*="/cart/add"], form[action="/cart/add"]');
        if (form) return form;
        el = el.parentElement;
      }
      return null;
    }

    function collectCustomizerInputs(root) {
      var selector = 'input, select, textarea';
      var all = Array.prototype.slice.call(root.querySelectorAll(selector));
      return all.filter(function (el) {
        if (el.type === 'button' || el.type === 'submit' || el.disabled) return false;
        // Nur Felder, die entweder data-ps-prop haben oder mit ps_ beginnen
        if (el.hasAttribute('data-ps-prop')) return true;
        if (el.name && el.name.indexOf('ps_') === 0) return true;
        return false;
      });
    }

    function valueFrom(el) {
      if (el.type === 'checkbox') return el.checked ? el.value || 'Ja' : '';
      if (el.type === 'radio') {
        var group = el.form
          ? el.form.querySelector('input[name="' + el.name + '"]:checked')
          : document.querySelector('input[name="' + el.name + '"]:checked');
        return group ? group.value : '';
      }
      return (el.value || '').toString();
    }

    function makePropertyName(el) {
      if (el.hasAttribute('data-ps-prop')) return el.getAttribute('data-ps-prop');
      if (el.name && el.name.indexOf('ps_') === 0) return el.name.replace(/^ps_/, '').replace(/_/g, ' ');
      return el.name || 'Option';
    }

    function syncPropertiesIntoForm(customizerRoot, form) {
      // Alte, von uns erzeugte Inputs entfernen
      Array.prototype.slice.call(form.querySelectorAll('[data-ps-generated="1"]')).forEach(function (n) {
        n.parentElement && n.parentElement.removeChild(n);
      });

      var inputs = collectCustomizerInputs(customizerRoot);
      inputs.forEach(function (src) {
        var val = valueFrom(src);
        if (!val) return; // leere Werte nicht senden
        var key = makePropertyName(src);
        var hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'properties[' + key + ']';
        hidden.value = val;
        hidden.setAttribute('data-ps-generated', '1');
        form.appendChild(hidden);
      });
    }

    function init(root) {
      var form = findProductForm(root);
      if (!form) return;

      var sync = function () {
        syncPropertiesIntoForm(root, form);
      };

      // Bei Formular-Submit sicherstellen, dass Properties drin sind
      form.addEventListener(
        'submit',
        function () {
          sync();
        },
        { capture: true }
      );

      // Live bei Änderungen synchronisieren
      root.addEventListener('change', sync);
      root.addEventListener('input', function (e) {
        var t = e.target;
        if (t && (t.hasAttribute('data-ps-prop') || (t.name && t.name.indexOf('ps_') === 0))) sync();
      });

      // Initial einmal syncen
      sync();
    }

    document.addEventListener('DOMContentLoaded', function () {
      var nodes = document.querySelectorAll('[data-ps-customizer]');
      Array.prototype.forEach.call(nodes, init);
    });

    // Für Theme-Editor (Ajax-Ladezyklen)
    document.addEventListener('shopify:section:load', function (e) {
      var root = e.target && e.target.querySelector && e.target.querySelector('[data-ps-customizer]');
      if (root) init(root);
    });
  })();
</script>

<style>
  .ps-product-customizer .ps-fields {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px 16px;
    margin: 16px 0 8px;
  }
  @media (max-width: 749px) {
    .ps-product-customizer .ps-fields {
      grid-template-columns: 1fr;
    }
  }
  .ps-product-customizer .field label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .ps-product-customizer .field input,
  .ps-product-customizer .field select,
  .ps-product-customizer .field textarea {
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 14px;
  }
  .ps-product-customizer .field textarea {
    resize: vertical;
  }
  .ps-product-customizer .field input:focus,
  .ps-product-customizer .field select:focus,
  .ps-product-customizer .field textarea:focus {
    outline: none;
    border-color: #111827;
    box-shadow: 0 0 0 2px rgba(17, 24, 39, 0.1);
  }
</style>

{% schema %}
{
  "name": "PS Product Customizer",
  "tag": "section",
  "class": "section",
  "limit": 1,
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": []
}
{% endschema %}
